<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIRPSS | Werewolf Game</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://gc.fynn.qzz.io/icon_2.png">
    <script src="https://cdn.fynn.qzz.io/layout.js" defer></script> 
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: #F1F5F9; min-height: 100vh; transition: background-color 1s ease; }
        .blob-bg { position: fixed; border-radius: 50%; mix-blend-mode: screen; filter: blur(60px); opacity: 0.3; pointer-events: none; transition: all 1s ease; z-index: 0; }
        .hidden { display: none !important; }
        .modal-enter { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-enter-active { opacity: 1; transform: scale(1); pointer-events: auto; transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        .btn { width: 100%; padding: 1rem; border-radius: 0.75rem; font-weight: 800; text-transform: uppercase; transition: all 0.2s; margin-bottom: 0.5rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; }
        .btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-1px); }
        .btn-action { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); border: none; }
    </style>
</head>
<body class="flex flex-col relative mode-night">
    <div id="blob-container" class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div id="blob-1" class="blob-bg bg-indigo-600/20 w-96 h-96 top-0 left-1/4 animate-drift"></div>
        <div id="blob-2" class="blob-bg bg-purple-600/20 w-80 h-80 top-40 right-1/4 animate-drift"></div>
    </div>
    <chirpss-header></chirpss-header>

    <main class="relative z-10 flex-grow flex flex-col items-center justify-center p-4 w-full max-w-xl mx-auto">
        <div id="loading-view" class="text-center animate-pulse"><h1 class="text-xl font-bold text-indigo-400 uppercase tracking-widest">Loading...</h1></div>

        <div id="narrator-view" class="hidden w-full text-center py-10 transition-all duration-500">
            <div id="narrator-icon" class="text-6xl mb-8 opacity-80 animate-bounce">üåë</div>
            <h2 id="narrator-sub" class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Phase</h2>
            <h1 id="narrator-main" class="text-4xl sm:text-5xl font-black text-white mb-12 leading-tight drop-shadow-2xl">...</h1>
            <button id="wake-btn" onclick="revealRoleView()" class="hidden w-full max-w-xs py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-extrabold text-xl rounded-xl shadow-lg mx-auto">I Am Ready</button>
        </div>

        <div id="action-view" class="hidden w-full bg-slate-900/60 border border-white/10 rounded-3xl p-6 shadow-2xl backdrop-blur-md"></div>

        <div id="day-view" class="hidden w-full text-center">
            <div class="bg-slate-900/60 border border-white/10 rounded-3xl p-8 shadow-2xl backdrop-blur-md mb-8">
                <div class="text-6xl mb-4">‚òÄÔ∏è</div>
                <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400 mb-4">Morning Report</h2>
                <div id="morning-report" class="text-lg text-white font-medium leading-relaxed space-y-2">...</div>
            </div>
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Actions</h3>
            <div id="vote-buttons" class="grid grid-cols-1 gap-2"></div>
        </div>
    </main>

    <div id="custom-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm modal-enter transition-all duration-200">
        <div class="bg-slate-900 border border-white/10 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden p-6 text-center">
            <h3 id="modal-title" class="text-xl font-black text-white mb-2"></h3>
            <p id="modal-msg" class="text-gray-400 text-sm mb-6"></p>
            <div id="modal-actions" class="flex gap-2 justify-center"></div>
        </div>
    </div>

    <div id="game-over-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl modal-enter transition-all duration-500">
        <div class="text-center max-w-md w-full">
            <div class="text-8xl mb-6">üèÜ</div>
            <h1 id="go-winner" class="text-5xl font-black text-white mb-4 leading-tight">WINNER</h1>
            <p id="go-msg" class="text-lg text-gray-400 font-medium mb-12"></p>
            <button onclick="window.location.href='index.html'" class="w-full py-4 bg-white text-slate-900 font-extrabold rounded-xl uppercase">Return to Menu</button>
        </div>
    </div>

    <script>
        const CDN_BASE = "https://cdn.fynn.qzz.io/Werewolf";
        let ROLES_DB = {};
        let GameContext = { players: [], phase: 'init', turn: 0, nightActions: {}, activeRoleIndex: 0, nightOrder: [], links: [], lynchedId: null, dousedIds: [], cultIds: [], wolfCubDied: false };
        window.RoleRegistry = {}; window.WinRegistry = {}; 

        document.addEventListener('DOMContentLoaded', async () => {
            const payload = sessionStorage.getItem('werewolf_payload');
            if(!payload) return window.location.href = 'index.html';
            GameContext.players = JSON.parse(payload);
            try {
                const res = await fetch(`${CDN_BASE}/Data/roles.json`);
                const data = await res.json();
                ROLES_DB = data.roles;
                await Promise.all([loadRoleScripts(), loadWinScripts()]);
                document.getElementById('loading-view').classList.add('hidden');
                startNightPhase();
            } catch (err) { showModal("Error", "Game failed to load.", () => window.location.href = 'index.html'); }
        });

        async function loadRoleScripts() {
            const activeRoles = [...new Set(GameContext.players.map(p => p.role))];
            const promises = activeRoles.map(r => {
                const config = ROLES_DB[r];
                if(config.hasNightAction && config.script && !window.RoleRegistry[r]) return loadScript(`${CDN_BASE}/Night/${config.script}`);
                return Promise.resolve();
            });
            await Promise.all(promises);
        }
        async function loadWinScripts() {
            const activeRoles = [...new Set(GameContext.players.map(p => p.role))];
            if(!activeRoles.includes('Villager')) activeRoles.push('Villager');
            if(!activeRoles.includes('Werewolf')) activeRoles.push('Werewolf');
            const promises = activeRoles.map(r => {
                const config = ROLES_DB[r];
                if(config.winScript) return loadScript(`${CDN_BASE}/WinConditions/${config.winScript}`);
                return Promise.resolve();
            });
            await Promise.all(promises);
        }
        function loadScript(src) {
            return new Promise((resolve) => {
                const s = document.createElement('script'); s.src = src; s.onload = resolve; s.onerror = resolve; document.head.appendChild(s);
            });
        }

        // --- CORE ENGINE ---
        function startNightPhase() {
            GameContext.phase = 'night'; GameContext.nightActions = {}; GameContext.lynchedId = null; GameContext.turn++;
            document.body.className = 'mode-night';
            document.getElementById('blob-1').className = "blob-bg bg-indigo-900/20 w-96 h-96 top-0 left-1/4 animate-drift";
            
            // Check for Apprentice Seer promotion if Seer dead
            const seerAlive = GameContext.players.find(p => p.role === 'Seer' && p.isAlive);
            const appSeer = GameContext.players.find(p => p.role === 'Apprentice Seer' && p.isAlive);
            if(!seerAlive && appSeer) appSeer.promoted = true;

            const awake = GameContext.players.filter(p => p.isAlive && ROLES_DB[p.role].hasNightAction);
            GameContext.nightOrder = awake.sort((a, b) => (ROLES_DB[a.role].priority || 99) - (ROLES_DB[b.role].priority || 99));
            GameContext.activeRoleIndex = 0;
            
            showNarrator("Night has fallen...", false);
            setTimeout(() => nextTurn(), 3000);
        }

        function nextTurn() {
            if(GameContext.activeRoleIndex >= GameContext.nightOrder.length) { resolveNight(); return; }
            const p = GameContext.nightOrder[GameContext.activeRoleIndex];
            showNarrator(`${p.role}, wake up.`, true);
        }

        function revealRoleView() {
            document.getElementById('narrator-view').classList.add('hidden');
            const container = document.getElementById('action-view');
            container.classList.remove('hidden'); container.innerHTML = '';
            const p = GameContext.nightOrder[GameContext.activeRoleIndex];

            // 1. Roleblock Check
            if(GameContext.nightActions.blockedId === p.id) {
                container.innerHTML = `<div class="text-center"><h2 class="text-3xl font-black text-red-500 mb-4">BLOCKED!</h2><p class="text-gray-400 mb-8">You cannot use your ability tonight.</p><button class="btn btn-action" onclick="finishTurn()">Sleep</button></div>`;
                return;
            }

            if(window.RoleRegistry[p.role]) container.innerHTML = window.RoleRegistry[p.role].renderUI(GameContext, p);
            else container.innerHTML = `<div class="text-center"><button class="btn btn-action" onclick="finishTurn()">Continue</button></div>`;
        }

        window.finishTurn = function(data) {
            if(data) {
                if(data.lovers) GameContext.links = data.lovers; 
                if(data.doused) GameContext.dousedIds = [...new Set([...GameContext.dousedIds, data.doused])];
                if(data.converted) GameContext.cultIds.push(data.converted);
                if(data.thiefSwap) { /* Thief swap logic would go here in full implementation */ }
                if(data.wolfCubDied) GameContext.wolfCubDied = true;
                
                // If Necromancer revives
                if(data.necromancerRevive) {
                    const target = GameContext.players.find(pl => pl.id === data.necromancerRevive);
                    if(target) target.isAlive = true;
                }

                Object.assign(GameContext.nightActions, data);
            }
            const p = GameContext.nightOrder[GameContext.activeRoleIndex];
            document.getElementById('action-view').classList.add('hidden');
            showNarrator(`${p.role}, close your eyes.`, false);
            setTimeout(() => {
                document.getElementById('narrator-main').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('narrator-main').style.opacity = '1';
                    GameContext.activeRoleIndex++; nextTurn();
                }, 3000); 
            }, 3000); 
        };

        function resolveNight() {
            showNarrator("The sun is rising...", false);
            setTimeout(() => {
                document.body.className = 'mode-day';
                document.getElementById('blob-1').className = "blob-bg bg-blue-500/20 w-96 h-96 top-0 left-1/4 animate-drift";
                
                let confirmedDeaths = new Set();
                let protectionSet = new Set(); 
                const na = GameContext.nightActions;

                // Protections
                if (na.bodyguardSave) protectionSet.add(na.bodyguardSave);
                if (na.priestSave) protectionSet.add(na.priestSave + "_wolfonly"); // Tag specifically
                if (na.doctorSave) protectionSet.add(na.doctorSave);
                if (na.witchUsedHeal && na.wolfTarget) protectionSet.add(na.wolfTarget);

                // Attacks
                // 1. Guard Dog Logic
                if (na.wolfTarget) {
                    const targetPlayer = GameContext.players.find(pl => pl.id === na.wolfTarget);
                    if (targetPlayer && targetPlayer.role === 'Guard Dog') {
                        // Guard Dog survives, Random Wolf dies
                        const wolves = GameContext.players.filter(pl => pl.team === 'Werewolf' && pl.isAlive);
                        if(wolves.length > 0) {
                            const deadWolf = wolves[Math.floor(Math.random() * wolves.length)];
                            confirmedDeaths.add(deadWolf.id);
                        }
                        targetPlayer.role = 'Villager'; // Converts
                    } else {
                        // Standard Wolf Attack
                        let isProtected = protectionSet.has(na.wolfTarget) || protectionSet.has(na.wolfTarget + "_wolfonly");
                        if (!isProtected) confirmedDeaths.add(na.wolfTarget);
                    }
                }
                
                // 2. Other Killers
                if (na.skTarget && !protectionSet.has(na.skTarget)) confirmedDeaths.add(na.skTarget);
                if (na.witchKill) confirmedDeaths.add(na.witchKill);
                if (na.whiteWolfKill) confirmedDeaths.add(na.whiteWolfKill);
                if (na.knightKill) confirmedDeaths.add(na.knightKill);
                
                // 3. Arsonist Ignite
                if (na.ignite) GameContext.dousedIds.forEach(id => confirmedDeaths.add(id));

                // 4. Lovers Chain
                let loop = true;
                while(loop) {
                    loop = false;
                    if(GameContext.links && GameContext.links.length === 2) {
                        const [p1, p2] = GameContext.links;
                        if(confirmedDeaths.has(p1) && !confirmedDeaths.has(p2)) { confirmedDeaths.add(p2); loop = true; }
                        if(confirmedDeaths.has(p2) && !confirmedDeaths.has(p1)) { confirmedDeaths.add(p1); loop = true; }
                    }
                }

                // Apply Deaths
                let msgHtml = "";
                let huntersDied = [];
                if (confirmedDeaths.size === 0) msgHtml = "It was a peaceful night. No one died.";
                else {
                    const names = [];
                    confirmedDeaths.forEach(id => {
                        const p = GameContext.players.find(pl => pl.id === id);
                        if(p) { 
                            p.isAlive = false; 
                            names.push(p.name);
                            if(p.role === 'Hunter' || p.role === 'Corrupt Hunter') huntersDied.push(p);
                            if(p.role === 'Wolf Cub') GameContext.wolfCubDied = true;
                        }
                    });
                    msgHtml = `<p class="text-red-400 font-bold mb-2">Tragedy struck!</p>` + names.map(n => `<p>${n} was found dead.</p>`).join('');
                }

                startDay(msgHtml, huntersDied);
            }, 4000);
        }

        function startDay(msgHtml, huntersDied) {
            document.getElementById('narrator-view').classList.add('hidden');
            document.getElementById('day-view').classList.remove('hidden');
            document.getElementById('morning-report').innerHTML = msgHtml;
            
            // Handle Hunter Triggers immediately via Queue
            if(huntersDied && huntersDied.length > 0) {
                handleHunterQueue(huntersDied, 0);
                return;
            }

            if(checkWin()) return;
            renderDayActions();
        }

        function handleHunterQueue(hunters, index) {
            if(index >= hunters.length) { renderDayActions(); return; }
            const hunter = hunters[index];
            
            const alive = GameContext.players.filter(p => p.isAlive);
            // Create a modal to choose target
            const container = document.createElement('div');
            container.innerHTML = `<h3 class="text-white font-bold mb-2">${hunter.name} (${hunter.role}), choose your target!</h3>`;
            const grid = document.createElement('div'); grid.className="grid grid-cols-2 gap-2";
            
            alive.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "btn bg-red-900/50 hover:bg-red-800 text-xs";
                btn.innerText = p.name;
                btn.onclick = () => {
                    p.isAlive = false;
                    alert(`${hunter.name} shot ${p.name}!`); // Keeping alert for chain simplicity or replace with modal later
                    document.body.removeChild(modal);
                    handleHunterQueue(hunters, index + 1);
                };
                grid.appendChild(btn);
            });
            container.appendChild(grid);
            
            // Custom overlay for hunter
            const modal = document.createElement('div');
            modal.className = "fixed inset-0 z-[70] flex items-center justify-center bg-black/90 p-4";
            modal.appendChild(container);
            document.body.appendChild(modal);
        }

        function renderDayActions() {
            const alive = GameContext.players.filter(p => p.isAlive);
            const container = document.getElementById('vote-buttons');
            container.innerHTML = '';

            // 1. Gunner Check
            const gunner = alive.find(p => p.role === 'Gunner');
            if(gunner && !gunner.hasShot) {
                const gunBtn = document.createElement('button');
                gunBtn.className = "w-full py-3 mb-4 bg-orange-600 text-white font-bold rounded-xl uppercase tracking-widest";
                gunBtn.innerText = `üî´ Gunner Action (${gunner.name})`;
                gunBtn.onclick = () => {
                    gunner.hasShot = true;
                    // Show gunner kill UI (simplified: just list targets)
                    showModal("Gunner Shoot", "Select a target to kill immediately.", null, null); 
                    // To implement properly, reuse the Hunter Queue UI logic here.
                    // For MVP: Just alert "Gunner used ability"
                    alert("Gunner logic requires full UI. Implemented via console in debugging.");
                };
                container.appendChild(gunBtn);
            }

            // 2. Voting List
            alive.forEach(p => {
                const btn = document.createElement('button');
                btn.className = "bg-white/5 border border-white/10 p-4 rounded-xl font-bold hover:bg-white/10 text-left w-full mb-2 flex justify-between";
                btn.innerHTML = `<span>${p.name}</span> <span class="text-xs text-gray-500 font-bold opacity-50">VOTE</span>`;
                btn.onclick = () => lynch(p.id);
                container.appendChild(btn);
            });
        }

        window.lynch = function(id) {
            const p = GameContext.players.find(x => x.id === id);
            showModal("Cast Vote?", `Eliminate ${p.name}?`, () => {
                p.isAlive = false;
                GameContext.lynchedId = id;
                showModal("Result", `${p.name} was voted out.\nRole: ${p.role}`, () => {
                    if(!checkWin()) startNightPhase();
                });
            }, () => {});
        };

        function showNarrator(text, btn) {
            const view = document.getElementById('narrator-view');
            document.getElementById('day-view').classList.add('hidden');
            document.getElementById('action-view').classList.add('hidden');
            view.classList.remove('hidden');
            document.getElementById('narrator-main').innerText = text;
            if(btn) document.getElementById('wake-btn').classList.remove('hidden');
            else document.getElementById('wake-btn').classList.add('hidden');
        }

        function showModal(title, msg, onConfirm, onCancel) {
            const m = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-msg').innerText = msg;
            const act = document.getElementById('modal-actions');
            act.innerHTML = '';
            
            if(onCancel) {
                const c = document.createElement('button'); c.innerText="Cancel"; c.className="flex-1 py-3 bg-white/10 rounded-xl font-bold text-xs"; c.onclick=() => { m.classList.remove('modal-enter-active'); m.classList.add('modal-enter'); onCancel(); }; act.appendChild(c);
            }
            const k = document.createElement('button'); k.innerText="Confirm"; k.className="flex-1 py-3 bg-indigo-600 rounded-xl font-bold text-xs"; k.onclick=() => { m.classList.remove('modal-enter-active'); m.classList.add('modal-enter'); if(onConfirm) onConfirm(); }; act.appendChild(k);
            m.classList.remove('modal-enter'); m.classList.add('modal-enter-active');
        }

        function checkWin() {
            let wins = [];
            Object.values(window.WinRegistry).forEach(f => { const r = f(GameContext); if(r) wins.push(r); });
            if(wins.length > 0) {
                wins.sort((a,b) => b.priority - a.priority);
                const w = wins[0];
                document.getElementById('game-over-modal').classList.remove('modal-enter');
                document.getElementById('game-over-modal').classList.add('modal-enter-active');
                document.getElementById('go-winner').innerText = w.winner;
                document.getElementById('go-msg').innerText = w.message;
                return true;
            }
            return false;
        }
    </script>
</body>
</html>
