<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIRPSS | Werewolf Game</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" type="image/png" href="https://gc.fynn.qzz.io/icon_2.png">
    <script src="https://cdn.fynn.qzz.io/layout.js" defer></script> 

    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f172a; color: #F1F5F9; overflow-x: hidden; min-height: 100vh; transition: background-color 1s ease; }
        .blob-bg { position: fixed; border-radius: 50%; mix-blend-mode: screen; filter: blur(60px); opacity: 0.3; pointer-events: none; transition: all 1s ease; z-index: 0; }
        .hidden { display: none !important; }
        
        /* Modal Animation */
        .modal-enter { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-enter-active { opacity: 1; transform: scale(1); pointer-events: auto; transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1); }

        /* Buttons */
        .btn { width: 100%; padding: 1rem; border-radius: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.05em; transition: all 0.2s; margin-bottom: 0.5rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; }
        .btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-1px); }
        .btn-action { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); border: none; }
    </style>
</head>
<body class="flex flex-col relative mode-night">

    <div id="blob-container" class="fixed inset-0 overflow-hidden pointer-events-none z-0">
        <div id="blob-1" class="blob-bg bg-indigo-600/20 w-96 h-96 top-0 left-1/4 animate-drift"></div>
        <div id="blob-2" class="blob-bg bg-purple-600/20 w-80 h-80 top-40 right-1/4 animate-drift"></div>
    </div>

    <chirpss-header></chirpss-header>

    <main class="relative z-10 flex-grow flex flex-col items-center justify-center p-4 w-full max-w-xl mx-auto">
        
        <div id="loading-view" class="text-center animate-pulse">
            <h1 class="text-xl font-bold text-indigo-400 uppercase tracking-widest">Entering the Village...</h1>
        </div>

        <div id="narrator-view" class="hidden w-full text-center py-10 transition-all duration-500">
            <div id="narrator-icon" class="text-6xl mb-8 opacity-80 animate-bounce">üåë</div>
            <h2 id="narrator-sub" class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Phase</h2>
            <h1 id="narrator-main" class="text-4xl sm:text-5xl font-black text-white mb-12 leading-tight drop-shadow-2xl">...</h1>
            <button id="wake-btn" onclick="revealRoleView()" class="hidden w-full max-w-xs py-4 bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-extrabold text-xl rounded-xl shadow-lg hover:scale-[1.02] active:scale-95 transition-all uppercase tracking-widest mx-auto">
                I Am Ready
            </button>
        </div>

        <div id="action-view" class="hidden w-full bg-slate-900/60 border border-white/10 rounded-3xl p-6 shadow-2xl backdrop-blur-md"></div>

        <div id="day-view" class="hidden w-full text-center">
            <div class="bg-slate-900/60 border border-white/10 rounded-3xl p-8 shadow-2xl backdrop-blur-md mb-8">
                <div class="text-6xl mb-4">‚òÄÔ∏è</div>
                <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-400 mb-4">Morning Report</h2>
                <div id="morning-report" class="text-lg text-white font-medium leading-relaxed space-y-2">...</div>
            </div>
            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Town Square Vote</h3>
            <div id="vote-buttons" class="grid grid-cols-2 gap-2"></div>
        </div>

    </main>

    <div id="custom-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/80 backdrop-blur-sm modal-enter transition-all duration-200">
        <div class="bg-slate-900 border border-white/10 rounded-2xl w-full max-w-sm shadow-2xl overflow-hidden p-6 text-center">
            <h3 id="modal-title" class="text-xl font-black text-white mb-2">Title</h3>
            <p id="modal-msg" class="text-gray-400 text-sm mb-6">Message goes here.</p>
            <div id="modal-actions" class="flex gap-2 justify-center">
                </div>
        </div>
    </div>

    <div id="game-over-modal" class="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/95 backdrop-blur-xl modal-enter transition-all duration-500">
        <div class="text-center max-w-md w-full">
            <div id="go-icon" class="text-8xl mb-6 filter drop-shadow-[0_0_30px_rgba(255,255,255,0.3)]">üèÜ</div>
            <h2 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-4">Game Over</h2>
            <h1 id="go-winner" class="text-5xl font-black text-white mb-4 leading-tight">WINNER</h1>
            <p id="go-msg" class="text-lg text-gray-400 font-medium mb-12">The game has ended.</p>
            <button onclick="window.location.href='index.html'" class="w-full py-4 bg-white text-slate-900 font-extrabold rounded-xl hover:bg-gray-200 uppercase tracking-widest">Return to Menu</button>
        </div>
    </div>

    <script>
        const CDN_BASE = "https://cdn.fynn.qzz.io/Werewolf";
        
        let ROLES_DB = {};
        let GameContext = {
            players: [],
            phase: 'init',
            turn: 0,
            nightActions: {},
            activeRoleIndex: 0,
            nightOrder: [],
            links: [],
            lynchedId: null
        };
        
        window.RoleRegistry = {}; 
        window.WinRegistry = {}; 

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', async () => {
            const payload = sessionStorage.getItem('werewolf_payload');
            if(!payload) return window.location.href = 'index.html';
            GameContext.players = JSON.parse(payload);

            try {
                const res = await fetch(`${CDN_BASE}/Data/roles.json`);
                const data = await res.json();
                ROLES_DB = data.roles;

                await Promise.all([loadRoleScripts(), loadWinScripts()]);

                document.getElementById('loading-view').classList.add('hidden');
                startNightPhase();

            } catch (err) {
                console.error(err); // Log error instead of alert
                showModal("Error", "Game failed to load data. Returning to menu.", () => {
                    window.location.href = 'index.html';
                });
            }
        });

        async function loadRoleScripts() {
            const activeRoles = [...new Set(GameContext.players.map(p => p.role))];
            const promises = activeRoles.map(r => {
                const config = ROLES_DB[r];
                if(config.hasNightAction && config.script && !window.RoleRegistry[r]) {
                    return loadScript(`${CDN_BASE}/Night/${config.script}`);
                }
                return Promise.resolve();
            });
            await Promise.all(promises);
        }

        async function loadWinScripts() {
            const activeRoles = [...new Set(GameContext.players.map(p => p.role))];
            if(!activeRoles.includes('Villager')) activeRoles.push('Villager');
            if(!activeRoles.includes('Werewolf')) activeRoles.push('Werewolf');

            const promises = activeRoles.map(r => {
                const config = ROLES_DB[r];
                if(config.winScript) {
                    return loadScript(`${CDN_BASE}/WinConditions/${config.winScript}`);
                }
                return Promise.resolve();
            });
            await Promise.all(promises);
        }

        function loadScript(src) {
            return new Promise((resolve) => {
                const s = document.createElement('script');
                s.src = src;
                s.onload = resolve;
                s.onerror = resolve; 
                document.head.appendChild(s);
            });
        }

        // --- MODAL SYSTEM (NO MORE ALERTS) ---
        function showModal(title, msg, onConfirm, onCancel = null) {
            const modal = document.getElementById('custom-modal');
            const titleEl = document.getElementById('modal-title');
            const msgEl = document.getElementById('modal-msg');
            const actions = document.getElementById('modal-actions');

            titleEl.innerText = title;
            msgEl.innerText = msg;
            actions.innerHTML = '';

            if (onCancel) {
                // Two buttons (Confirm/Cancel)
                const cancelBtn = document.createElement('button');
                cancelBtn.className = "flex-1 py-3 bg-white/5 hover:bg-white/10 text-gray-400 font-bold rounded-xl transition-all uppercase tracking-widest text-xs";
                cancelBtn.innerText = "Cancel";
                cancelBtn.onclick = () => { closeModal(); onCancel(); };
                actions.appendChild(cancelBtn);

                const confirmBtn = document.createElement('button');
                confirmBtn.className = "flex-1 py-3 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl transition-all uppercase tracking-widest text-xs";
                confirmBtn.innerText = "Confirm";
                confirmBtn.onclick = () => { closeModal(); onConfirm(); };
                actions.appendChild(confirmBtn);
            } else {
                // One button (OK)
                const okBtn = document.createElement('button');
                okBtn.className = "w-full py-3 bg-white text-slate-900 font-bold rounded-xl hover:bg-gray-200 uppercase tracking-widest text-xs";
                okBtn.innerText = "OK";
                okBtn.onclick = () => { closeModal(); if(onConfirm) onConfirm(); };
                actions.appendChild(okBtn);
            }

            modal.classList.remove('modal-enter');
            modal.classList.add('modal-enter-active');
        }

        function closeModal() {
            const modal = document.getElementById('custom-modal');
            modal.classList.remove('modal-enter-active');
            modal.classList.add('modal-enter');
        }

        function showGameOver(title, msg, colorClass) {
            const modal = document.getElementById('game-over-modal');
            document.getElementById('go-winner').innerText = title;
            document.getElementById('go-winner').className = `text-5xl font-black mb-4 leading-tight ${colorClass}`;
            document.getElementById('go-msg').innerText = msg;
            
            modal.classList.remove('modal-enter');
            modal.classList.add('modal-enter-active');
        }

        // --- NIGHT ENGINE ---
        function startNightPhase() {
            GameContext.phase = 'night';
            GameContext.nightActions = {}; 
            GameContext.lynchedId = null;

            document.body.className = 'mode-night';
            document.getElementById('blob-1').className = "blob-bg bg-indigo-900/20 w-96 h-96 top-0 left-1/4 animate-drift";
            document.getElementById('blob-2').className = "blob-bg bg-purple-900/20 w-80 h-80 top-40 right-1/4 animate-drift";

            const awake = GameContext.players.filter(p => p.isAlive && ROLES_DB[p.role].hasNightAction);
            GameContext.nightOrder = awake.sort((a, b) => (ROLES_DB[a.role].priority || 99) - (ROLES_DB[b.role].priority || 99));
            GameContext.activeRoleIndex = 0;
            
            showNarrator("Night has fallen...", false);
            setTimeout(() => nextTurn(), 3000);
        }

        function nextTurn() {
            if(GameContext.activeRoleIndex >= GameContext.nightOrder.length) {
                resolveNight();
                return;
            }
            const p = GameContext.nightOrder[GameContext.activeRoleIndex];
            showNarrator(`${p.role}, wake up.`, true);
        }

        function revealRoleView() {
            document.getElementById('narrator-view').classList.add('hidden');
            const container = document.getElementById('action-view');
            container.classList.remove('hidden');
            container.innerHTML = '';

            const p = GameContext.nightOrder[GameContext.activeRoleIndex];
            if(window.RoleRegistry[p.role]) {
                container.innerHTML = window.RoleRegistry[p.role].renderUI(GameContext, p);
            } else {
                container.innerHTML = `<div class="text-center"><button class="btn btn-action" onclick="finishTurn()">Continue</button></div>`;
            }
        }

        window.finishTurn = function(data) {
            if(data) {
                if(data.lovers) GameContext.links = data.lovers; 
                Object.assign(GameContext.nightActions, data);
            }
            const p = GameContext.nightOrder[GameContext.activeRoleIndex];
            
            document.getElementById('action-view').classList.add('hidden');
            showNarrator(`${p.role}, close your eyes.`, false);
            
            setTimeout(() => {
                // The Void
                document.getElementById('narrator-main').style.opacity = '0';
                document.getElementById('narrator-sub').style.opacity = '0';
                document.getElementById('narrator-icon').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('narrator-main').style.opacity = '1';
                    document.getElementById('narrator-sub').style.opacity = '1';
                    document.getElementById('narrator-icon').style.opacity = '0.8';
                    GameContext.activeRoleIndex++;
                    nextTurn();
                }, 3000); 
            }, 3000); 
        };

        function showNarrator(text, showButton) {
            const view = document.getElementById('narrator-view');
            const main = document.getElementById('narrator-main');
            const sub = document.getElementById('narrator-sub');
            const btn = document.getElementById('wake-btn');
            
            document.getElementById('day-view').classList.add('hidden');
            document.getElementById('action-view').classList.add('hidden');
            view.classList.remove('hidden');

            sub.innerText = showButton ? "Action Phase" : "Transition";
            main.innerText = text;
            if(showButton) btn.classList.remove('hidden'); else btn.classList.add('hidden');
        }

        function resolveNight() {
            showNarrator("The sun is rising...", false);
            setTimeout(() => {
                document.body.className = 'mode-day';
                document.getElementById('blob-1').className = "blob-bg bg-blue-500/20 w-96 h-96 top-0 left-1/4 animate-drift";
                document.getElementById('blob-2').className = "blob-bg bg-cyan-500/20 w-80 h-80 top-40 right-1/4 animate-drift";

                let confirmedDeaths = new Set();
                let protectionSet = new Set(); 

                const { wolfTarget, skTarget, witchKill, doctorSave, witchUsedHeal } = GameContext.nightActions;

                if (doctorSave) protectionSet.add(doctorSave);
                if (witchUsedHeal && wolfTarget) protectionSet.add(wolfTarget);

                if (wolfTarget && !protectionSet.has(wolfTarget)) confirmedDeaths.add(wolfTarget);
                if (skTarget && !protectionSet.has(skTarget)) confirmedDeaths.add(skTarget);
                if (witchKill) confirmedDeaths.add(witchKill);

                // Lovers Chain
                let loop = true;
                while(loop) {
                    loop = false;
                    if(GameContext.links && GameContext.links.length === 2) {
                        const [p1, p2] = GameContext.links;
                        if(confirmedDeaths.has(p1) && !confirmedDeaths.has(p2)) { confirmedDeaths.add(p2); loop = true; }
                        if(confirmedDeaths.has(p2) && !confirmedDeaths.has(p1)) { confirmedDeaths.add(p1); loop = true; }
                    }
                }

                let msgHtml = "";
                if (confirmedDeaths.size === 0) {
                    msgHtml = "It was a peaceful night. No one died.";
                } else {
                    const names = [];
                    confirmedDeaths.forEach(id => {
                        const p = GameContext.players.find(pl => pl.id === id);
                        if(p) { p.isAlive = false; names.push(p.name); }
                    });
                    msgHtml = `<p class="text-red-400 font-bold mb-2">Tragedy struck!</p>` + names.map(n => `<p>${n} was found dead.</p>`).join('');
                }

                startDay(msgHtml);
            }, 4000);
        }

        function startDay(msgHtml) {
            document.getElementById('narrator-view').classList.add('hidden');
            document.getElementById('day-view').classList.remove('hidden');
            document.getElementById('morning-report').innerHTML = msgHtml;
            
            // Check win after night deaths
            if(checkWin()) return;

            const alive = GameContext.players.filter(p => p.isAlive);
            document.getElementById('vote-buttons').innerHTML = alive.map(p => `
                <button onclick="lynch('${p.id}')" class="bg-white/5 border border-white/10 p-4 rounded-xl font-bold hover:bg-white/10 text-left transition-all flex justify-between items-center group">
                    <span class="text-white group-hover:text-blue-300 transition-colors">${p.name}</span>
                    <span class="text-xs text-gray-500 uppercase font-bold tracking-wider opacity-0 group-hover:opacity-100">Vote</span>
                </button>
            `).join('');
        }

        window.lynch = function(id) {
            const p = GameContext.players.find(x => x.id === id);
            
            // Replaced Browser Confirm with Custom Modal
            showModal(
                "Cast Vote?", 
                `Are you sure you want to eliminate ${p.name}?`,
                () => {
                    // ON CONFIRM
                    p.isAlive = false;
                    GameContext.lynchedId = id;
                    
                    // Show Result via Modal, THEN continue
                    showModal(
                        "Execution Complete",
                        `${p.name} was voted out.\nThey were: ${p.role}`,
                        () => {
                            // After they click "OK" on the death report...
                            
                            // Check Lovers Day Death
                            if(GameContext.links.length === 2) {
                                const [l1, l2] = GameContext.links;
                                let brokenHeartName = null;
                                if(l1 === id) { 
                                    const p2 = GameContext.players.find(x => x.id === l2);
                                    if(p2 && p2.isAlive) { p2.isAlive = false; brokenHeartName = p2.name; }
                                }
                                if(l2 === id) {
                                    const p1 = GameContext.players.find(x => x.id === l1);
                                    if(p1 && p1.isAlive) { p1.isAlive = false; brokenHeartName = p1.name; }
                                }
                                
                                if(brokenHeartName) {
                                    showModal("Heartbreak", `${brokenHeartName} died of a broken heart!`, () => {
                                        finalizeDay();
                                    });
                                    return;
                                }
                            }
                            
                            finalizeDay();
                        }
                    );
                },
                () => { /* On Cancel - Do nothing */ }
            );
        };
        
        function finalizeDay() {
            if(!checkWin()) {
                startNightPhase();
            }
        }

        // --- WIN CHECKER ---
        function checkWin() {
            let potentialWins = [];

            Object.values(window.WinRegistry).forEach(checkFunc => {
                const result = checkFunc(GameContext);
                if (result) potentialWins.push(result);
            });

            if (potentialWins.length > 0) {
                potentialWins.sort((a, b) => b.priority - a.priority);
                const finalWin = potentialWins[0];
                
                // Use Custom Game Over Screen
                showGameOver(finalWin.winner + " Wins!", finalWin.message, finalWin.color);
                return true;
            }
            return false;
        }
    </script>
</body>
</html>
