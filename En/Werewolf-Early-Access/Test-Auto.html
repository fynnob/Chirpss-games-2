<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIRPSS | Werewolf Ultra-Validator v3.0</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'JetBrains Mono', monospace; background: #020617; color: #cbd5e1; height: 100vh; overflow: hidden; }
        .debug-grid { display: grid; grid-template-columns: 350px 1fr; height: 100%; gap: 1px; background: #1e293b; }
        .panel { background: #020617; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; }
        .log-entry { border-bottom: 1px solid #1e293b; padding: 8px; font-size: 11px; transition: background 0.2s; }
        .pass { border-left: 4px solid #10b981; background: rgba(16, 185, 129, 0.05); }
        .fail { border-left: 4px solid #ef4444; background: rgba(239, 68, 68, 0.1); color: #f87171; }
        .info { border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.05); color: #60a5fa; }
        .fuzz { border-left: 4px solid #a855f7; background: rgba(168, 85, 247, 0.05); color: #c084fc; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body class="debug-grid">

    <div class="panel border-r border-slate-800">
        <h1 class="text-xl font-black text-white mb-2 tracking-tighter">ENGINE VALIDATOR</h1>
        <p class="text-xs text-slate-500 mb-8 font-bold uppercase tracking-widest">Stress Test v3.0</p>

        <div id="stats-container" class="space-y-3 mb-8">
            </div>

        <div class="space-y-2">
            <button onclick="runAllTests()" id="run-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-3 rounded-lg transition-all shadow-lg shadow-indigo-500/20">
                ðŸš€ RUN FULL SUITE
            </button>
            <button onclick="clearLogs()" class="w-full bg-slate-800 hover:bg-slate-700 text-slate-300 font-bold py-2 rounded-lg text-xs">
                CLEAR CONSOLE
            </button>
        </div>

        <div class="mt-auto pt-4 border-t border-slate-800">
            <h3 class="text-[10px] font-bold text-slate-600 uppercase mb-2">Diagnostic Mode</h3>
            <div class="flex items-center gap-2">
                <input type="checkbox" id="stop-on-fail" class="rounded bg-slate-800 border-slate-700">
                <label for="stop-on-fail" class="text-[10px] text-slate-400">Stop on first failure</label>
            </div>
        </div>
    </div>

    <div class="panel p-0 bg-black/20">
        <div class="p-4 bg-slate-900/50 border-b border-slate-800 flex justify-between items-center">
            <span class="text-xs font-bold text-slate-500">REAL-TIME EXECUTION LOG</span>
            <span id="progress-indicator" class="text-[10px] font-mono text-indigo-400 uppercase">Idle</span>
        </div>
        <div id="log-output" class="flex-grow">
            <div class="p-20 text-center text-slate-700 italic font-mono text-sm">
                Waiting for initialization command...
            </div>
        </div>
    </div>

    <script>
        const CDN_BASE = "https://cdn.fynn.qzz.io/Werewolf";
        let ROLES_DB = {};
        window.RoleRegistry = {};
        window.WinRegistry = {};

        const tally = { total: 0, pass: 0, fail: 0, fuzz: 0 };

        // --- SIMULATOR ENGINE (Defensive & Corrected) ---
        function simulateNightResolution(ctx) {
            let confirmedDeaths = new Set();
            let protectionSet = new Set();
            const na = ctx.nightActions || {}; // Defensive

            // 1. Resolve Protections
            if (na.bodyguardSave) protectionSet.add(na.bodyguardSave);
            if (na.priestSave) protectionSet.add(na.priestSave + "_wolfonly");
            if (na.doctorSave) protectionSet.add(na.doctorSave);
            if (na.witchUsedHeal && na.wolfTarget) protectionSet.add(na.wolfTarget);

            // 2. Resolve Attacks
            if (na.wolfTarget) {
                const target = ctx.players.find(p => p.id === na.wolfTarget);
                if (target && target.role === 'Guard Dog') {
                    const wolves = ctx.players.filter(p => p.team === 'Werewolf' && p.isAlive);
                    if (wolves.length > 0) confirmedDeaths.add(wolves[0].id);
                } else {
                    if (!protectionSet.has(na.wolfTarget) && !protectionSet.has(na.wolfTarget + "_wolfonly")) {
                        confirmedDeaths.add(na.wolfTarget);
                    }
                }
            }

            // Fixed/Independent Kills
            ['skTarget', 'witchKill', 'whiteWolfKill', 'knightKill'].forEach(key => {
                if (na[key] && !protectionSet.has(na[key])) confirmedDeaths.add(na[key]);
            });

            // 3. Chain Reactions (Lovers)
            let loop = true;
            while (loop) {
                loop = false;
                if (ctx.links && ctx.links.length === 2) {
                    const [p1, p2] = ctx.links;
                    if (confirmedDeaths.has(p1) && !confirmedDeaths.has(p2)) { confirmedDeaths.add(p2); loop = true; }
                    if (confirmedDeaths.has(p2) && !confirmedDeaths.has(p1)) { confirmedDeaths.add(p1); loop = true; }
                }
            }

            return ctx.players.map(p => ({
                ...p,
                isAlive: confirmedDeaths.has(p.id) ? false : p.isAlive
            }));
        }

        // --- TEST RUNNER ---
        async function runAllTests() {
            Object.assign(tally, { total: 0, pass: 0, fail: 0, fuzz: 0 });
            document.getElementById('log-output').innerHTML = '';
            document.getElementById('progress-indicator').innerText = "Running...";
            
            // 1. Win Condition Tests
            await runWinLogicTests();
            
            // 2. Role Interaction Tests (Night Actions)
            await runInteractionTests();

            // 3. Voting & Day Tests
            await runDayTests();

            // 4. The Fuzzer (Stress Test)
            await runStressFuzzer(100);

            updateStats();
            document.getElementById('progress-indicator').innerText = "Complete";
        }

        async function runWinLogicTests() {
            log("category", "Starting Win Condition Logic Tests");

            // Test Village Win (Pure)
            assertWin("Village Victory", {
                players: [{id:'p1', role:'Villager', team:'Village', isAlive:true}, {id:'p2', role:'Werewolf', team:'Werewolf', isAlive:false}],
                links: [], nightActions: {}
            }, 'Village', 'Village should win if all wolves are dead.');

            // Test Wolf Win (Outnumber)
            assertWin("Werewolf Victory", {
                players: [{id:'p1', role:'Werewolf', team:'Werewolf', isAlive:true}, {id:'p2', role:'Villager', team:'Village', isAlive:true}],
                links: [], nightActions: {}
            }, 'Werewolf', 'Wolves should win when equal to villagers.');

            // Test Mixed Lovers Stalemate (Custom Logic)
            assertWin("Lovers Stalemate", {
                players: [{id:'v', role:'Villager', team:'Village', isAlive:true}, {id:'w', role:'Werewolf', team:'Werewolf', isAlive:true}],
                links: ['v', 'w'], nightActions: {}
            }, null, 'No winner should be declared in a mixed-team lover stalemate.');
        }

        async function runInteractionTests() {
            log("category", "Starting Night Action Interaction Tests");

            // Test Guard Dog
            const gdRes = simulateNightResolution({
                players: [{id:'w', role:'Werewolf', team:'Werewolf', isAlive:true}, {id:'d', role:'Guard Dog', team:'Village', isAlive:true}],
                nightActions: { wolfTarget: 'd' }
            });
            assert(gdRes.find(p => p.id === 'w').isAlive === false, "Guard Dog: Wolf should die.");
            assert(gdRes.find(p => p.id === 'd').isAlive === true, "Guard Dog: Dog should live.");
        }

        async function runDayTests() {
            log("category", "Starting Day/Voting Simulation Tests");

            const jesterLynch = {
                players: [{id:'j', role:'Jester', team:'Neutral', isAlive:false}],
                lynchedId: 'j'
            };
            const jesterWin = window.WinRegistry.Jester ? window.WinRegistry.Jester(jesterLynch) : null;
            assert(jesterWin && jesterWin.winner === 'Jester', "Jester Lynch: Jester should win upon lynching.");
        }

        async function runStressFuzzer(iterations) {
            log("category", `Running Fuzzer: ${iterations} Randomized Scenarios`);
            for(let i=0; i<iterations; i++) {
                tally.total++;
                try {
                    // Randomize 4 players
                    const p = [
                        {id:'p1', role:'Villager', team:'Village', isAlive:true},
                        {id:'p2', role:'Werewolf', team:'Werewolf', isAlive:true},
                        {id:'p3', role:'Doctor', team:'Village', isAlive:true},
                        {id:'p4', role:'Serial Killer', team:'Neutral', isAlive:true}
                    ];
                    const actions = {
                        wolfTarget: 'p'+(Math.floor(Math.random()*4)+1),
                        doctorSave: 'p'+(Math.floor(Math.random()*4)+1),
                        skTarget: 'p'+(Math.floor(Math.random()*4)+1)
                    };
                    
                    const res = simulateNightResolution({ players: p, nightActions: actions });
                    
                    // Safety check: Can't have more alive than we started
                    if (res.filter(x => x.isAlive).length > 4) throw new Error("Zombie proliferation detected.");
                    
                    tally.pass++;
                    tally.fuzz++;
                } catch(e) {
                    tally.fail++;
                    log("fail", `Fuzz Error [${i}]: ${e.message}`);
                }
            }
        }

        // --- UTILS ---
        function assertWin(name, ctx, expected, failMsg) {
            tally.total++;
            try {
                let winner = null;
                const wins = Object.values(window.WinRegistry).map(f => f(ctx)).filter(x => x !== null);
                if(wins.length > 0) {
                    wins.sort((a,b) => b.priority - a.priority);
                    winner = wins[0].winner;
                }

                if(winner === expected) {
                    tally.pass++;
                    log("pass", `${name}: Logic Correct.`);
                } else {
                    tally.fail++;
                    log("fail", `${name}: Expected [${expected}] but got [${winner}]. ${failMsg}`);
                }
            } catch(e) {
                tally.fail++;
                log("fail", `${name}: Execution Error -> ${e.message}`);
            }
        }

        function assert(condition, msg) {
            tally.total++;
            if(condition) {
                tally.pass++;
                log("pass", msg);
            } else {
                tally.fail++;
                log("fail", `ASSERTION FAILED: ${msg}`);
            }
        }

        function log(type, msg) {
            const out = document.getElementById('log-output');
            if(tally.total === 1) out.innerHTML = '';
            const div = document.createElement('div');
            div.className = `log-entry ${type === 'category' ? 'info font-bold' : type}`;
            div.innerHTML = `[${type.toUpperCase()}] ${msg}`;
            out.prepend(div);
        }

        function updateStats() {
            const container = document.getElementById('stats-container');
            container.innerHTML = `
                ${statBox("TOTAL TESTS", tally.total, "slate")}
                ${statBox("PASSED", tally.pass, "green")}
                ${statBox("FAILED", tally.fail, "red")}
                ${statBox("FUZZ SUCCESS", tally.fuzz, "purple")}
            `;
        }

        function statBox(label, val, color) {
            return `<div class="bg-slate-900 border border-${color}-900/30 p-4 rounded-xl">
                <span class="text-[10px] font-bold text-slate-500 block uppercase">${label}</span>
                <span class="text-2xl font-black text-${color}-400">${val}</span>
            </div>`;
        }

        function clearLogs() { document.getElementById('log-output').innerHTML = ''; }

        // --- FETCH DB ---
        async function load() {
            try {
                const r = await fetch(`${CDN_BASE}/Data/roles.json`);
                ROLES_DB = (await r.json()).roles;
                log("info", "System: Role Database loaded.");
                
                // Pre-load essential win conditions for the test
                const scripts = ['village.js', 'werewolf.js', 'jester.js'];
                for(let s of scripts) {
                    const sc = document.createElement('script');
                    sc.src = `${CDN_BASE}/WinConditions/${s}`;
                    document.head.appendChild(sc);
                }
            } catch(e) { log("fail", "System: Could not fetch Roles.json."); }
        }
        load();
    </script>
</body>
</html>
