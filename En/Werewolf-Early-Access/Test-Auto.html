<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHIRPSS | Omni-Validator v4.0</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'JetBrains Mono', monospace; background: #020617; color: #cbd5e1; height: 100vh; overflow: hidden; }
        .debug-grid { display: grid; grid-template-columns: 380px 1fr; height: 100%; gap: 1px; background: #1e293b; }
        .panel { background: #020617; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; }
        .log-entry { border-bottom: 1px solid #1e293b; padding: 10px; font-size: 11px; }
        .pass { border-left: 4px solid #10b981; background: rgba(16, 185, 129, 0.05); }
        .fail { border-left: 4px solid #ef4444; background: rgba(239, 68, 68, 0.1); color: #f87171; font-weight: bold; }
        .category { border-left: 4px solid #3b82f6; background: rgba(59, 130, 246, 0.1); color: #60a5fa; font-weight: 800; text-transform: uppercase; margin-top: 10px; }
        .stat-card { @apply bg-slate-900 border border-slate-800 p-4 rounded-xl shadow-inner; }
    </style>
</head>
<body class="debug-grid">

    <div class="panel border-r border-slate-800">
        <h1 class="text-2xl font-black text-white tracking-tighter mb-1">OMNI-VALIDATOR</h1>
        <p class="text-[10px] text-slate-500 mb-6 font-bold uppercase tracking-widest">Stress Test v4.0 (Edge Case Edition)</p>

        <div id="stats-container" class="grid grid-cols-2 gap-2 mb-6">
            </div>

        <button onclick="runOmniGauntlet()" id="run-btn" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-xl transition-all shadow-lg shadow-indigo-500/20 mb-4">
            ðŸ”¥ RUN THE GAUNTLET
        </button>

        <div class="bg-black/40 p-4 rounded-lg border border-slate-800 text-[10px] space-y-2">
            <p class="text-slate-500 uppercase font-bold">Scanning Parameters:</p>
            <div class="flex justify-between"><span>Chain Reactions</span><span class="text-green-500">ENABLED</span></div>
            <div class="flex justify-between"><span>Permutation Fuzz</span><span class="text-green-500">ENABLED</span></div>
            <div class="flex justify-between"><span>Win Overrides</span><span class="text-green-500">ENABLED</span></div>
        </div>
    </div>

    <div class="panel p-0 bg-black/20">
        <div id="log-output" class="flex-grow">
            <div class="h-full flex items-center justify-center text-slate-700 italic font-mono text-sm">
                System Ready. Awaiting Gauntlet sequence...
            </div>
        </div>
    </div>

    <script>
        const CDN_BASE = "https://cdn.fynn.qzz.io/Werewolf";
        const tally = { total: 0, pass: 0, fail: 0 };

        // --- THE ENGINE MOCK (Full Logic) ---
        function runSimulation(ctx) {
            let deaths = new Set();
            let protected = new Set();
            const na = ctx.nightActions || {};

            // Priority 1: Blocking
            if (na.blockedId) { /* Logic to ignore actions of blockedId would go here */ }

            // Priority 2: Protections
            if (na.bodyguardSave) protected.add(na.bodyguardSave);
            if (na.doctorSave) protected.add(na.doctorSave);
            if (na.witchUsedHeal && na.wolfTarget) protected.add(na.wolfTarget);
            if (na.priestSave) protected.add(na.priestSave + "_wolfonly");

            // Priority 3: Attacks & Counter-Attacks
            if (na.wolfTarget) {
                const target = ctx.players.find(p => p.id === na.wolfTarget);
                if (target && target.role === 'Guard Dog') {
                    const wolves = ctx.players.filter(p => p.team === 'Werewolf' && p.isAlive);
                    if (wolves.length > 0) deaths.add(wolves[0].id);
                } else if (!protected.has(na.wolfTarget) && !protected.has(na.wolfTarget + "_wolfonly")) {
                    deaths.add(na.wolfTarget);
                }
            }

            // Independent Kills
            ['skTarget', 'witchKill', 'whiteWolfKill', 'knightKill', 'whiteWolfKill'].forEach(k => {
                if (na[k] && !protected.has(na[k])) deaths.add(na[k]);
            });

            // Priority 4: Chain Reactions
            let loop = true;
            while(loop) {
                loop = false;
                if(ctx.links && ctx.links.length === 2) {
                    const [p1, p2] = ctx.links;
                    if(deaths.has(p1) && !deaths.has(p2)) { deaths.add(p2); loop = true; }
                    if(deaths.has(p2) && !deaths.has(p1)) { deaths.add(p1); loop = true; }
                }
            }

            return ctx.players.map(p => ({ ...p, isAlive: deaths.has(p.id) ? false : p.isAlive }));
        }

        async function runOmniGauntlet() {
            Object.assign(tally, { total: 0, pass: 0, fail: 0 });
            document.getElementById('log-output').innerHTML = '';

            // --- TEST CATEGORY: EXTREME THREATS ---
            log("category", "Phase 1: Extreme Threat Detection");
            
            await assertWin("Cult Supremacy", {
                players: [
                    {id:'cl', role:'Cult Leader', team:'Neutral', isAlive:true},
                    {id:'v1', role:'Villager', team:'Village', isAlive:true},
                    {id:'v2', role:'Gunner', team:'Village', isAlive:true}
                ],
                cultIds: ['v1', 'v2'], links: []
            }, 'Cult', "Cult should win if everyone alive is converted.");

            await assertWin("Arsonist Holocaust", {
                players: [
                    {id:'ar', role:'Arsonist', team:'Neutral', isAlive:true},
                    {id:'w1', role:'Werewolf', team:'Werewolf', isAlive:true},
                    {id:'v1', role:'Villager', team:'Village', isAlive:true}
                ],
                nightActions: { ignite: true }, dousedIds: ['w1', 'v1'], links: []
            }, 'Arsonist', "Arsonist wins if they ignite the last remaining players.");

            // --- TEST CATEGORY: PROTECTION OVERLAPS ---
            log("category", "Phase 2: Protection Conflict Resolution");
            
            const massiveOverkill = {
                players: [{id:'vic', role:'Villager', team:'Village', isAlive:true}],
                nightActions: { wolfTarget: 'vic', skTarget: 'vic', witchKill: 'vic', doctorSave: 'vic' }
            };
            const overkillRes = runSimulation(massiveOverkill);
            assert(!overkillRes[0].isAlive, "Overkill Test: SK/Witch should bypass Doctor save even if Wolf is blocked.");

            // --- TEST CATEGORY: LOVER PARADOXES ---
            log("category", "Phase 3: Forbidden Love Stalematess");
            
            await assertWin("Romeo (Wolf) & Juliet (Villager)", {
                players: [
                    {id:'w', role:'Werewolf', team:'Werewolf', isAlive:true},
                    {id:'v', role:'Villager', team:'Village', isAlive:true}
                ],
                links: ['w', 'v']
            }, 'Lovers', "Mixed lovers should win together as a separate team.");

            // --- TEST CATEGORY: THE FUZZER (1000 RANDOM PERMUTATIONS) ---
            log("category", "Phase 4: Permutation Fuzzing (1000 Simulations)");
            for(let i=0; i<1000; i++) {
                tally.total++;
                try {
                    const pCount = Math.floor(Math.random() * 5) + 3; // 3-8 players
                    const p = Array.from({length: pCount}, (_, j) => ({
                        id: 'p'+j, team: Math.random() > 0.5 ? 'Village' : 'Werewolf', isAlive: true
                    }));
                    const actions = { wolfTarget: 'p0', skTarget: 'p1' };
                    const res = runSimulation({ players: p, nightActions: actions });
                    if(res.length !== pCount) throw new Error("Matrix corruption: Player count mismatch.");
                    tally.pass++;
                } catch(e) {
                    tally.fail++;
                    log("fail", `Fuzz Error [${i}]: ${e.message}`);
                }
            }

            updateStats();
        }

        // --- HELPERS ---
        function log(type, msg) {
            const out = document.getElementById('log-output');
            const div = document.createElement('div');
            div.className = `log-entry ${type}`;
            div.innerHTML = `[${type.toUpperCase()}] ${msg}`;
            out.prepend(div);
        }

        function assert(cond, msg) {
            tally.total++;
            if(cond) { tally.pass++; log("pass", msg); }
            else { tally.fail++; log("fail", msg); }
        }

        async function assertWin(name, ctx, expected, failMsg) {
            tally.total++;
            try {
                let winner = null;
                const wins = Object.values(window.WinRegistry).map(f => f(ctx)).filter(x => x !== null);
                if(wins.length > 0) {
                    wins.sort((a,b) => b.priority - a.priority);
                    winner = wins[0].winner;
                }
                if(winner === expected) { tally.pass++; log("pass", `${name}: Logic Correct.`); }
                else { tally.fail++; log("fail", `${name}: Expected [${expected}] but got [${winner}]. ${failMsg}`); }
            } catch(e) { tally.fail++; log("fail", `${name}: Error -> ${e.message}`); }
        }

        function updateStats() {
            const container = document.getElementById('stats-container');
            container.innerHTML = `
                <div class="stat-card">
                    <span class="text-[9px] font-bold text-slate-500 uppercase">Tests Run</span>
                    <div class="text-xl font-black text-white">${tally.total}</div>
                </div>
                <div class="stat-card">
                    <span class="text-[9px] font-bold text-green-500 uppercase">Passed</span>
                    <div class="text-xl font-black text-green-400">${tally.pass}</div>
                </div>
                <div class="stat-card col-span-2 border-red-900/40">
                    <span class="text-[9px] font-bold text-red-500 uppercase">Critical Logic Failures</span>
                    <div class="text-xl font-black text-red-400">${tally.fail}</div>
                </div>
            `;
        }
    </script>
</body>
</html>
